<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel â€” Drivers with Directions (No Socket)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

  <!-- QRCode library (used by your UI) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root { --accent: #0078ff; --muted: #7b8aa3; --bg: #f4f7fb; --card-bg: #fff; --success: #2ea44f; --danger: #d73a49; }
    * { box-sizing: border-box; }
    body { font-family: "Inter", system-ui, Arial, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #1e293b; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; flex-wrap:wrap; }
    h1 { color: var(--accent); font-size: 1.25rem; margin: 0; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    #searchInput { padding: 10px 12px; border-radius: 10px; border: 1px solid #d0d6df; width: 320px; font-size: 15px; outline: none; transition: 0.2s; }
    #searchInput:focus { border-color: var(--accent); box-shadow: 0 0 4px var(--accent); }
    .tableWrap { background: var(--card-bg); border-radius: 10px; padding: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 650px; }
    th, td { padding: 10px; border-bottom: 1px solid #eef2f7; text-align: left; vertical-align: top; }
    th { background: var(--accent); color: white; text-transform: uppercase; letter-spacing: 0.03em; }
    tr.onlineRow:hover { background: #ecfdf5; } tr.offlineRow:hover { background: #fff1f1; }
    .btn { background: var(--accent); color: white; padding: 5px 5px; border-radius: 8px; border: none; cursor: pointer; }
    .btn.secondary { background: #fff; color: var(--accent); border: 1px solid #e6edf6; }
    .small { color: var(--muted); font-size: 12px; color:black; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .pill { display:inline-block; padding:6px 8px; border-radius:999px; background:#f1f5f9; color:var(--muted); font-size:12px; margin-left:8px; }
    #mapPopup { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center; }
    #mapBox { width:92%; height:82%; background:var(--card-bg); border-radius:12px; overflow:hidden; position:relative; box-shadow: 0 10px 40px rgba(0,0,0,0.25); }
    #mapHeaderBar { display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid #eef2f7; }
    #mapCanvas { width:100%; height:calc(100% - 56px); } /* header is ~56px */
    #closeMap { position:absolute; right:14px; top:14px; background: var(--danger); color:white; border:none; width:36px; height:36px; border-radius:50%; cursor:pointer; z-index:99999; }
    .legend { position:absolute; left:14px; bottom:14px; background:rgba(255,255,255,0.95); padding:10px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,0.06); font-size:13px; }
    @media (max-width:900px){ #mapBox { width:96%; height:74%; } table { min-width:600px } #searchInput { width:100%; max-width:unset } }
    .fullmap {position: right; background:#f1eeee; color:rgb(0, 0, 0); border:none; border-radius:8px; cursor:pointer; font-size:29px; }

    @media (max-width: 900px) {
  #mapBox {
    width: 96%;
    height: 74%;
  }
  table {
    min-width: 100%;
    font-size: 12px;
  }
  #searchInput {
    width: 100%;
    max-width: unset;
  }
  .btn {
    width: 100%;
    text-align: center;
  }
}
  </style>
</head>
<body>

  <!-- QR UIs (kept from your original; optional) -->
  <div class="qrcode" id="hiip" style="transform:scale(0); position:fixed; left:40%; top:12%; z-index:12000; background:white; padding:12px; border-radius:12px;">
    <div id="p"></div>
    <div style="text-align:center; margin-top:8px;">
      <button id="payclose" style="background:#f97316;color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer">Close QR</button>
    </div>
  </div>

  <div class="qrcode" id="hii" style="transform:scale(0); position:fixed; left:40%; top:12%; z-index:12000; background:white; padding:12px; border-radius:12px;">
    <div id="q"></div>
    <div style="text-align:center; margin-top:8px;">
      <button id="chintuDownload" style="background:#4f46e5;color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer">Download QR</button>
      <button id="cliclose" style="background:#f97316;color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;margin-left:6px">Close</button>
    </div>
  </div>

  <header>
    <div>
      <h1>Admin â€” Drivers & Live Routes</h1>
      <div class="small">Monitor drivers, open per-driver map and stream rider location (no sockets).</div>
    </div>

    <div class="toolbar">
      <input id="searchInput" placeholder="Search name, gmail or mobile" />
      <button class="btn" id="refreshBtn">Refresh</button>
      <div class="pill">Total: <span id="driverCount">0</span></div>
    </div>
  </header>

  <main class="tableWrap card">
    <table>
      <thead>
        <tr><th>Name</th><th>Status</th><th>Bookings</th><th>Actions</th></tr>
      </thead>
      <tbody id="driverTableBody">
        <tr><td colspan="6" class="small">Loading driversâ€¦</td></tr>
      </tbody>
    </table>
  </main>

  <!-- Map popup -->
  <div id="mapPopup" onclick="if(event.target === this) closeMapPopup()">
    <div id="mapBox" role="dialog" aria-modal="true">
      <div id="mapHeaderBar">
        <div id="mapHeader" class="small">Driver: â€”</div>
        <div style="flex:1"></div>
        <label class="small" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="streamRiderToggle" /> <span>Stream rider location</span>
        </label>
        <button id="recenterBtn" class="btn secondary" style="margin-left:8px">Recenter</button>
        <button class="fullmap" id="toggleFullscreen">â›¶</button>
      </div>

      <div id="mapCanvas"></div>
      <div class="legend"><strong>Legend:</strong><br>Green = Driver â€” Blue = Rider</div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
(function () {

  // ============================
  // CONFIG
  // ============================
  const API_BASE = "";
  const POLL_DRIVERS_MS = 12000;
  const POLL_DRIVER_MS = 3000;

  // ============================
  // STATE
  // ============================
  let allDrivers = [];
  let mapInstance = null;
  let driverMarker = null;
  let riderMarkers = [];
  let routeLayers = [];
  let liveWatchId = null;
  let livePollInterval = null;

  let activeDriverId = null;
  let activeRiderId = null;

  // ============================
  // DOM
  // ============================
  const driverCountEl = document.getElementById("driverCount");
  const tbody = document.getElementById("driverTableBody");
  const searchInput = document.getElementById("searchInput");
  const refreshBtn = document.getElementById("refreshBtn");

  const mapPopup = document.getElementById("mapPopup");
  const mapCanvas = document.getElementById("mapCanvas");
  const closeMapBtn = document.getElementById("closeMap");
  const mapHeader = document.getElementById("mapHeader");
  const streamToggle = document.getElementById("streamRiderToggle");
  const recenterBtn = document.getElementById("recenterBtn");

  // ============================
  // HELPERS
  // ============================
  function normalizeDrivers(input) {
    if (!input) return [];
    if (Array.isArray(input)) return input;

    if (input.drivers && Array.isArray(input.drivers)) return input.drivers;

    if (typeof input === "object") {
      return Object.keys(input).map(k => ({ id: k, ...(input[k] || {}) }));
    }
    return [];
  }

  async function fetchDrivers() {
    try {
      const res = await fetch(API_BASE + "/showDrivers");
      const json = await res.json();
      return normalizeDrivers(json);
    } catch (e) {
      console.error("fetchDrivers error", e);
      return [];
    }
  }

  async function getDriverById(driverId) {
    const quick = allDrivers.find(d => d.id === driverId);
    if (quick) return quick;

    const res = await fetch(API_BASE + "/showDrivers");
    const json = await res.json();
    allDrivers = normalizeDrivers(json);

    return allDrivers.find(d => d.id === driverId) || null;
  }

  async function deleteDriverRemote(driverId) {
    try {
      const r = await fetch(API_BASE + "/driver/" + encodeURIComponent(driverId), {
        method: "DELETE"
      });
      if (r.ok) return true;
    } catch {}

    try {
      const r2 = await fetch(API_BASE + "/admin/deleteDriver", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: driverId })
      });
      if (r2.ok) return true;
    } catch {}

    return false;
  }

  // ============================
  // RENDER TABLE
  // ============================
  async function renderTable() {
    const q = (searchInput.value || "").trim().toLowerCase();
    tbody.innerHTML = "";
    let count = 0;

    for (const d of allDrivers) {
      if (!d) continue;

      if (q && !(d.name || "").toLowerCase().includes(q)) continue;

      count++;
      const tr = document.createElement("tr");
      tr.className = d.online ? "onlineRow" : "offlineRow";

      tr.innerHTML = `
        <td>${d.name || "-"}</td>
        <td>${d.online ? "ðŸŸ¢On" : "ðŸ”´Off"}</td>
        <td>
          <div class="small">R1: ${d.Rider1_id || "-"} â€” Code ${d.Booking1_code || "-"}</div>
          <div class="small" style="margin-top:6px;">R2: ${d.Rider2_id || "-"} â€” Code ${d.Booking2_code || "-"}</div>
          <div class="actions">
            <button class="btn secondary" data-driver="${d.id}" data-rider="${d.Rider1_id || ""}" data-action="view-r">View R1</button>
            <button class="btn secondary" data-driver="${d.id}" data-rider="${d.Rider2_id || ""}" data-action="view-r">View R2</button>
          </div>
        </td>
        <td>
          <button class="btn" data-id="${d.id}" data-action="delete">Delete</button>
        </td>
      `;

      tbody.appendChild(tr);
    }

    driverCountEl.textContent = count;

    tbody.querySelectorAll('[data-action="delete"]').forEach(btn => {
      btn.onclick = async () => {
        const code = prompt("Enter admin code:");
        if (code !== "Chintu@Admin2025") return alert("Invalid code");

        if (!confirm("Delete this driver?")) return;

        const ok = await deleteDriverRemote(btn.dataset.id);
        if (ok) {
          alert("Deleted");
          refreshDrivers();
        } else {
          alert("Failed");
        }
      };
    });

    tbody.querySelectorAll('[data-action="view-r"]').forEach(btn => {
      btn.onclick = () => {
        openMapForDriver(btn.dataset.driver, btn.dataset.rider);
      };
    });
  }

  async function refreshDrivers() {
    allDrivers = await fetchDrivers();
    await renderTable();
  }

  refreshDrivers();
  setInterval(refreshDrivers, POLL_DRIVERS_MS);

  refreshBtn.onclick = refreshDrivers;
  searchInput.oninput = renderTable;

  // ============================
  // MAP CLEANUP
  // ============================
  function cleanupMap() {
    if (mapInstance) {
      mapInstance.remove();
      mapInstance = null;
    }
    if (driverMarker) driverMarker.remove();
    riderMarkers.forEach(m => m.remove());
    routeLayers.forEach(r => r.remove());

    riderMarkers = [];
    routeLayers = [];

    if (liveWatchId !== null) {
      navigator.geolocation.clearWatch(liveWatchId);
      liveWatchId = null;
    }

    if (livePollInterval) {
      clearInterval(livePollInterval);
      livePollInterval = null;
    }

    activeDriverId = null;
    activeRiderId = null;
  }

  // ============================
  // ROUTES (OSRM)
  // ============================
  async function getOsrmRoute(a, b) {
    try {
      const url = `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
      const res = await fetch(url);
      const j = await res.json();
      if (!j.routes || !j.routes[0]) return null;

      return j.routes[0].geometry.coordinates.map(c => ({
        lat: c[1],
        lng: c[0]
      }));
    } catch {
      return null;
    }
  }

  async function recalcRoutes(origin, riders) {
    routeLayers.forEach(l => l.remove());
    routeLayers = [];

    for (const r of riders) {
      const coords = await getOsrmRoute(origin, r);
      if (!coords) continue;

      const line = L.polyline(coords, { color: "#0078ff", weight: 5 }).addTo(mapInstance);
      routeLayers.push(line);
    }
  }

  // ============================
  // OPEN MAP POPUP
  // ============================
  // ======================
// Custom Driver Icon
// ======================
const driverIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/3448/3448339.png", // driver icon image
  iconSize: [45, 45],
  iconAnchor: [22, 45],
  popupAnchor: [0, -40]
});

  async function openMapForDriver(driverId, riderId) {
    cleanupMap();

    mapPopup.style.display = "flex";

    activeDriverId = driverId;
    activeRiderId = riderId;

    const d = await getDriverById(driverId);
    if (!d || !d.Driver_lat || !d.Driver_lng) {
      alert("No driver location found");
      return closeMapPopup();
    }

    mapInstance = L.map(mapCanvas).setView(
      [Number(d.Driver_lat), Number(d.Driver_lng)],
      14
    );

    const street = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(mapInstance);

    const sat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19 }
    );

    L.control.layers({ Street: street, Satellite: sat }).addTo(mapInstance);

      driverMarker = L.marker(
        [Number(d.Driver_lat), Number(d.Driver_lng)],
        { icon: driverIcon }
      ).addTo(mapInstance);


    const riderPoints = [];
    if (d.Rider1_lat && d.Rider1_lng)
      riderPoints.push({
        lat: Number(d.Rider1_lat),
        lng: Number(d.Rider1_lng),
        id: d.Rider1_id
      });
    if (d.Rider2_lat && d.Rider2_lng)
      riderPoints.push({
        lat: Number(d.Rider2_lat),
        lng: Number(d.Rider2_lng),
        id: d.Rider2_id
      });

    riderMarkers = riderPoints.map(r =>
      L.marker([r.lat, r.lng]).addTo(mapInstance)
    );

    if (riderPoints.length)
      recalcRoutes(
        { lat: Number(d.Driver_lat), lng: Number(d.Driver_lng) },
        riderPoints
      );

    mapHeader.textContent = `Driver: ${d.name || d.id} â€” ${d.mobile || ""}`;

    // ============================ g2
    // LIVE POLLING DRIVER EVERY 3s
    // ============================
    livePollInterval = setInterval(async () => {
      const latest = await getDriverById(driverId);
      if (!latest) return;

      if (latest.Driver_lat && latest.Driver_lng) {
        driverMarker.setLatLng([
          Number(latest.Driver_lat),
          Number(latest.Driver_lng)
        ]);
      }

      // update riders
      const pts = [];
      if (latest.Rider1_lat && latest.Rider1_lng)
        pts.push({
          lat: Number(latest.Rider1_lat),
          lng: Number(latest.Rider1_lng)
        });
      if (latest.Rider2_lat && latest.Rider2_lng)
        pts.push({
          lat: Number(latest.Rider2_lat),
          lng: Number(latest.Rider2_lng)
        });

      riderMarkers.forEach(m => m.remove());
      riderMarkers = pts.map(p => L.marker([p.lat, p.lng]).addTo(mapInstance));

      if (pts.length)
        recalcRoutes(
          {
            lat: Number(latest.Driver_lat),
            lng: Number(latest.Driver_lng)
          },
          pts
        );
    }, POLL_DRIVER_MS);

    // ============================
    // STREAM RIDER LOCATION
    // ============================
    streamToggle.onchange = async () => {
      if (!streamToggle.checked) {
        if (liveWatchId !== null) {
          navigator.geolocation.clearWatch(liveWatchId);
          liveWatchId = null;
        }
        return;
      }

      if (!activeRiderId) {
        alert("No rider selected");
        streamToggle.checked = false;
        return;
      }

      liveWatchId = navigator.geolocation.watchPosition(
        async pos => {
          await fetch(API_BASE + "/riderLocation", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              riderId: activeRiderId,
              lat: pos.coords.latitude,
              lng: pos.coords.longitude
            })
          });
        },
        err => console.error(err),
        { enableHighAccuracy: true }
      );
    };

    recenterBtn.onclick = () => {
      mapInstance.setView(driverMarker.getLatLng(), 15);
    };
  }

  function closeMapPopup() {
    mapPopup.style.display = "none";
    cleanupMap();
  }

  window.openMapForDriver = openMapForDriver;
  window.closeMapPopup = closeMapPopup;

})();
 document.addEventListener('click', e => {
    if (e.target.id === 'toggleFullscreen') {
      const el = document.getElementById('mapBox');
      if (!document.fullscreenElement) { el.requestFullscreen().catch(err => console.error(err)); } else { document.exitFullscreen(); }
    }
  });
</script>
</body>
</html>

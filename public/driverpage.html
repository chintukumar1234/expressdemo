<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel ‚Äî Drivers with Directions (Leaflet + OSRM)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""/>

  <!-- Firebase (module) -->
  <script type="module">
/* ----------------------- FIREBASE IMPORTS ------------------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* ----------------------- FIREBASE CONFIG ------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCsZcn4VPhpnlgU0K_NPHPINjq9Qi5iVT8",
  authDomain: "mydatabase-e7c01.firebaseapp.com",
  databaseURL: "https://mydatabase-e7c01-default-rtdb.firebaseio.com",
  projectId: "mydatabase-e7c01",
  storageBucket: "mydatabase-e7c01.firebasestorage.app",
  messagingSenderId: "447471871540",
  appId: "1:447471871540:web:d48721caa65174b1598c61"
};

/* ---------------------- INITIALIZE FIREBASE ---------------------- */
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
import { io } from "https://cdn.socket.io/4.7.4/socket.io.esm.min.js";


/* ---------------------- GLOBAL STORAGE --------------------------- */
let allDrivers = {};
const socket = io({
  reconnection: true,
  reconnectionAttempts: Infinity,
  transports: ["websocket", "polling"]
});


/* ---------------------- LIVE FETCH DRIVERS ----------------------- */
onValue(ref(db, "drivers"), snapshot => {
  allDrivers = snapshot.exists() ? snapshot.val() : {};
  renderTable();
});

/* ------------------------ RENDER TABLE --------------------------- */
window.renderTable = function () {
  const tbody = document.getElementById("driverTableBody");
  tbody.innerHTML = "";
  let count = 0;

  const q = document.getElementById("searchInput").value.trim().toLowerCase();

  for (const id in allDrivers) {
    const d = allDrivers[id];
    if (!d) continue;

    // search
    if (q &&
      !((d.name || "").toLowerCase().includes(q) ||
        (d.gmail || "").toLowerCase().includes(q) ||
        (d.mobile || "").includes(q))) {
      continue;
    }

    count++;

    const tr = document.createElement("tr");
    tr.className = d.online ? "onlineRow" : "offlineRow";

    tr.innerHTML = `
      <td>${d.name || "-"}</td>
      <td>${d.gmail || "-"}</td>
      <td>${d.mobile || "-"}</td>
      <td>${d.online ? "üü¢ Online" : "üî¥ Offline"}</td>

      <td>
        <div>üë§ Rider1: ${d.Rider1_id || "-"}</div>
        <div>Code: ${d.Booking1_code || "-"}</div>
        <hr>
        <div>üë§ Rider2: ${d.Rider2_id || "-"}</div>
        <div>Code: ${d.Booking2_code || "-"}</div>
      </td>

      <td>
        <button class="viewMapBtn" data-id="${id}">üó∫Ô∏è View Map</button>
        <button class="deleteBtn" data-id="${id}">üóëÔ∏è Delete</button>
      </td>
    `;

    tbody.appendChild(tr);
  }

  document.getElementById("driverCount").innerText = count;

  /* ------------ DELETE BUTTON HANDLER ------------ */
  document.querySelectorAll(".deleteBtn").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;

      const code = prompt("üîê Enter admin code to delete this driver:");
      if (code !== "Chintu@Admin2025") {
        alert("‚ùå Invalid code.");
        return;
      }

      if (!confirm("‚ö†Ô∏è Delete this driver?")) return;

      try {
        await remove(ref(db, "drivers/" + id));
        alert("‚úÖ Driver deleted!");
      } catch (err) {
        console.error(err);
        alert("‚ùå Failed to delete driver");
      }
    };
  });

  /* ------------ VIEW MAP HANDLER ------------ */
  document.querySelectorAll(".viewMapBtn").forEach(btn => {
    btn.onclick = () => {
      openDriverMap(btn.dataset.id);
    };
  });
};

/* ====================================================================
                       LEAFLET + OSRM MAP VIEW
==================================================================== */

if (!window.L) {
  console.error("Leaflet not loaded! Include leaflet.js before this script.");
}

async function openDriverMap(driverId) {
  const popup = document.getElementById("mapPopup");
  popup.style.display = "flex";

  const mapEl = document.getElementById("mapCanvas");
  mapEl.innerHTML = "";

  /* ------------ FETCH DRIVER ------------ */
  const snap = await get(ref(db, "drivers/" + driverId));
  if (!snap.exists()) {
    alert("Driver not found");
    return;
  }

  let driver = snap.val();
  if (!driver.Driver_lat || !driver.Driver_lng) {
    alert("Driver has no location");
    return;
  }

  /* ------------ MAP SETUP ------------ */
  const map = L.map(mapEl);
  map.setView([driver.Driver_lat, driver.Driver_lng], 15);

  const streetLayer = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { maxZoom: 19 }
  ).addTo(map);

  const satelliteLayer = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 19 }
  );

  L.control.layers(
    { Street: streetLayer, Satellite: satelliteLayer },
    {},
    { position: "topright" }
  ).addTo(map);

  /* ------------ ICONS ------------ */
  const driverIcon = L.icon({
    iconUrl: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  });

  const riderIcon = L.icon({
    iconUrl: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
    iconSize: [28, 28],
    iconAnchor: [14, 28]
  });

  const riderLiveIcon = L.divIcon({
    className: "custom-rider",
    html: `
      <div class="rider-marker">
        <img src="https://cdn-icons-png.flaticon.com/128/1783/1783356.png">
      </div>
    `,
    iconSize: [40, 40],
    iconAnchor: [15, 42]
  });

  /* ------------ DRIVER MARKER ------------ */
  const driverMarker = L.marker(
    [driver.Driver_lat, driver.Driver_lng],
    { icon: driverIcon }
  ).addTo(map);

  /* ------------ RIDER STATIC MARKERS ------------ */
  const riderPoints = [];

  if (driver.Rider1_lat && driver.Rider1_lng) {
    riderPoints.push({
      lat: Number(driver.Rider1_lat),
      lng: Number(driver.Rider1_lng),
      label: "Rider 1"
    });
  }

  if (driver.Rider2_lat && driver.Rider2_lng) {
    riderPoints.push({
      lat: Number(driver.Rider2_lat),
      lng: Number(driver.Rider2_lng),
      label: "Rider 2"
    });
  }

  const riderMarkers = riderPoints.map(r =>
    L.marker([r.lat, r.lng], { icon: riderIcon })
      .addTo(map)
      .bindTooltip(r.label)
  );

  /* ------------ OSRM ROUTING ------------ */
  async function getOsrmRoute(a, b) {
    try {
      const url =
        `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;

      const res = await fetch(url);
      const json = await res.json();

      if (!json.routes) return null;

      return json.routes[0].geometry.coordinates.map(c => ({
        lat: c[1],
        lng: c[0]
      }));
    } catch (e) {
      console.error("OSRM error:", e);
      return null;
    }
  }

  let activePolylines = [];

  async function drawRoutes(fromPos) {
    activePolylines.forEach(p => p.remove());
    activePolylines = [];

    for (let i = 0; i < riderPoints.length; i++) {
      const route = await getOsrmRoute(fromPos, riderPoints[i]);
      if (!route) continue;

      const line = L.polyline([], {
        color: i === 0 ? "#0078ff" : "#ff4081",
        weight: 5
      }).addTo(map);

      activePolylines.push(line);

      let idx = 0;
      (function animate() {
        const end = Math.min(idx + 5, route.length);
        for (let k = idx; k < end; k++) line.addLatLng(route[k]);
        idx = end;
        if (idx < route.length) requestAnimationFrame(animate);
      })();
    }
  }

  await drawRoutes({ lat: driver.Driver_lat, lng: driver.Driver_lng });

  /* ------------ DRIVER LIVE MOVEMENT ------------ */
  function haversine(p1, p2) {
    const R = 6371;
    const dLat = (p2.lat - p1.lat) * Math.PI / 180;
    const dLng = (p2.lng - p1.lng) * Math.PI / 180;

    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(p1.lat * Math.PI / 180) *
      Math.cos(p2.lat * Math.PI / 180) *
      Math.sin(dLng / 2) ** 2;

    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  async function animateMarker(marker, path, duration = 1000) {
    return new Promise(resolve => {
      if (!path || path.length < 2) return resolve();

      const start = performance.now();

      const dist = [0];
      for (let i = 1; i < path.length; i++)
        dist.push(dist[i - 1] + haversine(path[i - 1], path[i]));

      const total = dist[dist.length - 1];
      if (total === 0) return resolve();

      function frame(now) {
        const t = Math.min((now - start) / duration, 1);
        const target = t * total;

        let i = 0;
        while (i < dist.length - 1 && dist[i + 1] < target) i++;

        const r = (target - dist[i]) / (dist[i + 1] - dist[i]);

        const p1 = path[i];
        const p2 = path[i + 1];

        marker.setLatLng([
          p1.lat + (p2.lat - p1.lat) * r,
          p1.lng + (p2.lng - p1.lng) * r
        ]);

        if (t < 1) requestAnimationFrame(frame);
        else resolve();
      }

      requestAnimationFrame(frame);
    });
  }

  socket.on("riderPositionUpdate", async ({ riderId, lat, lng }) => {
  const snap = await get(ref(db, "drivers"));
  const drivers = snap.val();
  if (!drivers) return;

  for (let driverId in drivers) {
    let d = drivers[driverId];

    // Rider is in slot 1
    if (d.Rider1_id === riderId) {
      await update(ref(db, "drivers/" + driverId), {
        Rider1_lat: lat,
        Rider1_lng: lng
      });
      return;
    }

    // Rider is in slot 2
    if (d.Rider2_id === riderId) {
      await update(ref(db, "drivers/" + driverId), {
        Rider2_lat: lat,
        Rider2_lng: lng
      });
      return;
    }
  }
});


  /* ------------ RIDER LIVE LOCATION ------------ */
  let riderLiveMarker = null;

  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      pos => {
        const { latitude, longitude } = pos.coords;

        if (!riderLiveMarker) {
          riderLiveMarker = L.marker([latitude, longitude], {
            icon: riderLiveIcon
          }).addTo(map);
        } else {
          riderLiveMarker.setLatLng([latitude, longitude]);
        }

        if (window.autoCenterRider) {
          map.setView([latitude, longitude]);
        }
      },
      err => alert("Location error: " + err.message),
      { enableHighAccuracy: true }
    );
  }

  /* ------------ CLEANUP ON CLOSE ------------ */
  popup._leafletCleanup = () => {
    try {
      activePolylines.forEach(p => p.remove());
      riderMarkers.forEach(m => m.remove());
      if (riderLiveMarker) riderLiveMarker.remove();
      driverMarker.remove();
      map.remove();
    } catch { }
  };
}

/* ------------------------- CLOSE MAP ------------------------- */
window.closeMapPopup = function () {
  const popup = document.getElementById("mapPopup");
  if (!popup) return;

  if (popup._leafletCleanup) popup._leafletCleanup();
  popup.style.display = "none";
};

/* ------------------------- FULLSCREEN ------------------------- */
document.addEventListener("click", e => {
  if (e.target.id === "toggleFullscreen") {
    const el = document.getElementById("mapBox");

    if (!document.fullscreenElement) {
      el.requestFullscreen().catch(err => console.error(err));
    } else {
      document.exitFullscreen();
    }
  }
});
</script>


  <!-- Leaflet JS (non-module; must be included before Leaflet use) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- QRCode library (used by your UI) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- üíÖ Modern Mobile-Friendly Styles -->
  <style>
    :root {
      --accent: #0078ff;
      --muted: #7b8aa3;
      --bg: #f4f7fb;
      --card-bg: #fff;
      --success: #2ea44f;
      --danger: #d73a49;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Inter", system-ui, Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 15px;
      color: #1e293b;
    }

    h1 {
      color: #173a6c;
      font-size: 1.5rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }

    #searchInput {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d0d6df;
      width: 100%;
      max-width: 320px;
      font-size: 15px;
      outline: none;
      transition: 0.2s;
    }

    #searchInput:focus {
      border-color: var(--accent);
      box-shadow: 0 0 4px var(--accent);
    }

    .tableWrap {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      min-width: 650px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #eef2f7;
      text-align: left;
      vertical-align: top;
    }

    th {
      background: var(--accent);
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    tr.onlineRow:hover { background: #ecfdf5; }
    tr.offlineRow:hover { background: #fef2f2; }

    .viewMapBtn, .deleteBtn {
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: #fff;
      font-size: 14px;
      transition: 0.2s;
      margin: 3px 0;
    }

    .viewMapBtn { background: var(--success); }
    .deleteBtn { background: var(--danger); }

    .viewMapBtn:hover { background: #22b55b; }
    .deleteBtn:hover { background: #f05252; }

    #mapPopup {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }

    #mapBox {
      width: 90%;
      height: 80%;
      background: var(--card-bg);
      border-radius: 14px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
      animation: fadeIn 0.3s ease;
    }

    #mapCanvas {
      width: 100%;
      height: 100%;
      /* Leaflet needs height; mapBox already defines height */
    }

    #closeMap {
      position: absolute;
      right: 14px;
      top: 14px;
      background: #ff5252;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      color: #fff;
      font-weight: bold;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 99999;
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      color: var(--muted);
    }

    #driverCount {
      font-weight: 600;
      color: var(--accent);
    }

    button {
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover { background: #005ed1; }

    .fullmap{
       position:absolute;
    left:96%;
    top:65px;
    z-index:99999;
    background:#f1eeee;
    color:rgb(0, 0, 0);
    border:none;
    border-radius:8px;
    padding:6px 10px;
    cursor:pointer;
    font-size:39px;
    }

    /* üåç Responsive */
    @media (max-width: 768px) {
      h1 { font-size: 1.25rem; }
      .tableWrap { padding: 6px; }
      th, td { padding: 8px; font-size: 13px; }
      #mapBox { width: 95%; height: 70%; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

.qrcode {
  position: fixed;
  padding: 15px;
  width: 20%;
  background: rgb(255, 255, 255);
  border-radius: 15px;
  box-shadow: 0 4px 15px rgb(0 0 0 / 20%);
  transform: scale(0);        /* Hidden initially */
  transform-origin: center;   /* Scale from center */
  transition: transform 0.5s ease;
  left: 40%;
  right: 40%;
}
.qrcodebutton {
  width: 100%;
  height: 35px;
  background-color: rgb(102, 117, 253);
  border-radius: 16px;
  cursor: pointer;
  margin: 10px 0 0 0 ;
}

.qrcodebutton:hover {
  background-color: rgb(36, 50, 245);
}
.qrcodeclose {
  width: 100%;
  height: 35px;
  background-color: rgb(241, 130, 56);
  border-radius: 16px;
  cursor: pointer;
  margin: 10px 0 0 0 ;
}

.qrcodeclose:hover {
  background-color: rgb(230, 46, 21);
}
@media (max-width: 600px) {
  .qrcode {
    padding: 12px;
    width: 90%;
    left: 5%;
  }

  .qrcodebutton {
    height: 38px;
    font-size: 15px;
  }
  .fullmap{
    left:84%;
  }
}

.logo {
  position: absolute;
  width: 90px;
  height: 90px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.logo img {
  width: 70px;
}

.rider-marker {
  width: 30px;
  height: 30px;
  padding: 6px;
  background: radial-gradient(circle, #ffffff 40%, #d7f5ff 100%);
  border-radius: 50%;
  box-shadow:
    0 4px 10px rgba(0, 0, 0, 0.25),
    0 0 15px #00c3ff;

  transform: translateY(0);
  animation: bounce 1.8s infinite ease-in-out;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
}

.rider-marker img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
}

  </style>
</head>

<body>
  <h1>Admin ‚Äî Drivers (with Directions)</h1>

  <div class="qrcode" id="hiip">
    <div id="p"></div>
     <div class="logo">
        <img src="https://tse1.mm.bing.net/th/id/OIP.r5wSc0-B3GQMSzAjIByfgQHaHZ?rs=1&pid=ImgDetMain&o=7&rm=3" alt="logo">
      </div>
    <button class="qrcodeclose" id="payclose">Close QR Code</button>
  </div>
    <div class="qrcode" id="hii">
<div id="q"></div>
<button class="qrcodebutton" onclick="chintu()">Download QR Code</button>
<button class="qrcodeclose" id="cliclose">Close QR Code</button>
</div>

<button id="clickhere">open QR code</button>

  <div class="toolbar">
    <div class="meta">
      <input id="searchInput" placeholder="Search name, gmail or mobile" oninput="renderTable()" />
      <div>Total: <span id="driverCount">0</span></div>
    </div>
    <div>
      <button onclick="renderTable()">Refresh</button>
      <button id="payhere" > payment</button>
    </div>
  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Name</th><th>Gmail</th><th>Mobile</th><th>Status</th><th>Bookings</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="driverTableBody">
        <tr><td colspan="6">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Map popup -->
  <div id="mapPopup" onclick="if(event.target===this) closeMapPopup()">
    <div id="mapBox">
      <button class="fullmap" id="toggleFullscreen"
  >
  ‚õ∂
</button>

      <div id="mapCanvas"></div>
    </div>
  </div>

  <!-- Small inline script for QR code UI (non-module) -->
  <script>
    document.getElementById("clickhere").addEventListener("click",function(){
      const result=document.getElementById("q");
      document.getElementById("q").innerHTML="";
      new QRCode(result,{
        text:"https://peoples-hfmh.onrender.com/",
        width:300,
        height:300
      });
      window.chintu=function(){
        const img=document.querySelector("#q img");
        const link=document.createElement("a");
        link.href=img.src;
        link.download="qr_code.png";
        link.click();
      }
      setTimeout(()=>{
        document.getElementById("hii").style.transform="scale(1)";
      },200);
    });

    document.getElementById("cliclose").addEventListener("click",function(){
      document.getElementById("hii").style.transform="scale(0)";
    });

    document.getElementById("payhere").addEventListener("click",function(){
      const result=document.getElementById("p");
      document.getElementById("p").innerHTML="";
      new QRCode(result,{
        text:"upi://pay?pa=chintukr32101-1@oksbi&pn=Chintu&cu=INR",
        width:300,
        height:300
      });
      setTimeout(()=>{
        document.getElementById("hiip").style.transform="scale(1)";
      },200);
    });
    document.getElementById("payclose").addEventListener("click",function(){
      document.getElementById("hiip").style.transform="scale(0)";
    });
  </script>
</body>
</html>

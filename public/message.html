<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="theme-color" content="#0078ff" />
<title>Driver - Multi Rider Tracker (Max 2)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<style>
  :root { --bg:#0f1724; --panel: rgba(10,10,12,0.9); --accent:#0078ff; --muted:#cbd5e1; }
  html,body{ height:100%; margin:0; font-family:Inter, system-ui, Arial; background:#eaf2ff; }
  #map{ height:100vh; width:100%; }

  .sidebar{ position:absolute; top:12px; left:12px; width:380px; max-height:92vh; background:var(--panel); color:white; padding:14px; border-radius:12px; box-shadow:0 8px 30px rgba(2,6,23,0.6); overflow:auto; z-index:1200; }
  .sidebar.closed{ transform:translateX(-420px); }
  .toggle-btn{ position:absolute; top:12px; left:12px; z-index:1300; background:#111; color:white; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; }
  h3{ margin:0 0 8px 0; font-size:18px; text-align:center; }
  .row { display:flex; gap:8px; align-items:center; }
  button,input,select{ font-size:14px; padding:8px; border-radius:8px; border:none; }
  button.primary{ background:var(--accent); color:white; width:100%; cursor:pointer; }
  button.ghost{ background:#4d4747; color:white; cursor:pointer; }
  .muted { color:var(--muted); font-size:13px; }
  .slot{ margin-top:10px; padding:10px; border-radius:8px; background:rgba(255,255,255,0.03); }
  .slot h4{ margin:0 0 6px 0; font-size:14px; }
  .small{ font-size:13px; color:#cbd5e1; margin-top:6px; }
  footer{ margin-top:10px; font-size:12px; color:#9aa4b2; text-align:center; }
  @media (max-width:480px){ .sidebar{ width:320px } .sidebar.closed{ transform:translateX(-360px);} }
</style>
</head>
<body>
<button class="toggle-btn" id="toggleBtn">☰</button>

<div class="sidebar closed" id="sidebar">

  <p>Status: <strong id="status">Not sharing</strong></p>
  <p class="muted">Speed: <span id="speed">0</span> km/h — Accuracy: <span id="accuracy">-</span> m</p>
  <p class="muted">Last updated: <span id="time">-</span></p>

  <div style="margin-top:8px">
    <button id="toggleShare" class="primary">Start Sharing</button>
    <div class="row" style="margin-top:8px;">
      <button id="toggleCenter" class="ghost">Auto-Center: ON</button>
      <select id="routeMode" style="flex:1;">
        <option value="car">Car</option>
        <option value="bike">Bike</option>
      </select>
    </div>
  </div>

  <hr style="border:none; height:1px; background:rgba(255,255,255,0.04); margin:12px 0;" />

  <div class="slot" id="slot1">
    <h4>Rider Slot 1</h4>
    <span>Mobile Number:
    <div id="rider1"></div>
    </span>
    <div id="slot1_info" class="small">Empty</div>
    <div class="row" style="margin-top:8px;">
      <button onclick="centerSlot('s1')" class="ghost" style="flex:1">Center</button>
      <button onclick="clearSlotPrompt('s1')" class="ghost" style="flex:1">Clear Slot</button>
    </div>
  </div>

  <div class="slot" id="slot2">
    <h4>Rider Slot 2</h4>
    <span>Mobile Number:
    <div id="rider2"></div>
    </span>
    <div id="slot2_info" class="small">Empty</div>
    <div class="row" style="margin-top:8px;">
      <button onclick="centerSlot('s2')" class="ghost" style="flex:1">Center</button>
      <button onclick="clearSlotPrompt('s2')" class="ghost" style="flex:1">Clear Slot</button>
    </div>
  </div>

  <hr style="border:none; height:1px; background:rgba(255,255,255,0.04); margin:12px 0;" />

  <input id="bookingCode" placeholder="Enter booking code to clear" style="width:95%; margin-bottom:8px;" />
  <button id="clearByCodeBtn" class="primary">Clear by Booking Code</button>
  <p id="message" class="small"></p>

  <footer>Connected driver persists across refresh (reconnect supported)</footer>
</div>

<!-- MAP CONTAINER -->
<div id="map"></div>

<!-- Firebase + App logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

/* ========== Firebase init (read-only listeners) ========== */
const firebaseConfig = {
  apiKey: "AIzaSyCsZcn4VPhpnlgU0K_NPHPINjq9Qi5iVT8",
  authDomain: "mydatabase-e7c01.firebaseapp.com",
  databaseURL: "https://mydatabase-e7c01-default-rtdb.firebaseio.com",
  projectId: "mydatabase-e7c01",
  storageBucket: "mydatabase-e7c01.appspot.com",
  messagingSenderId: "447471871540",
  appId: "1:447471871540:web:d48721caa65174b1598c61"
};
const fbApp = initializeApp(firebaseConfig);
const db = getDatabase(fbApp);

/* ========== State & UI refs ========== */
let sharing = 0;
let watchId = null;
let driverMarker = null;
let autoCenter = true;
let lastDriverPos = null;
let routeMode = "car";
const driverId = localStorage.getItem("userId"); // must be set on login
const slots = {
  s1: { riderId: null, bookingCode: null, marker: null, route: null },
  s2: { riderId: null, bookingCode: null, marker: null, route: null }
};

const statusEl = document.getElementById("status");
const shareBtn = document.getElementById("toggleShare");
const toggleBtn = document.getElementById("toggleBtn");
const speedEl = document.getElementById("speed");
const accEl = document.getElementById("accuracy");
const timeEl = document.getElementById("time");
const slot1Info = document.getElementById("slot1_info");
const slot2Info = document.getElementById("slot2_info");
const centerBtn = document.getElementById("toggleCenter");
const routeModeEl = document.getElementById("routeMode");
const bookingCodeInput = document.getElementById("bookingCode");
const clearByCodeBtn = document.getElementById("clearByCodeBtn");
const messageEl = document.getElementById("message");
const sidebar = document.getElementById("sidebar");

/* ========== Map init ========== */
const map = L.map('map').setView([20.5937,78.9629], 5); // India default view

const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
L.control.layers({ "Street Map": streetLayer, "Satellite": satelliteLayer }).addTo(map);

/* ========== UI wiring ========== */
toggleBtn.addEventListener("click", ()=> {
  sidebar.classList.toggle("closed");
  toggleBtn.textContent = sidebar.classList.contains("closed") ? "☰" : "✖";
});
shareBtn.addEventListener("click", ()=> sharing ? stopSharing() : startSharing());
centerBtn.addEventListener("click", ()=> { autoCenter = !autoCenter; centerBtn.textContent = `Auto-Center: ${autoCenter?"ON":"OFF"}`; });
routeModeEl.addEventListener("change", ()=> {
  routeMode = routeModeEl.value;
  // recreate routes with new profile
  ["s1","s2"].forEach(k => { if (slots[k].route) { try { map.removeControl(slots[k].route); } catch{} slots[k].route = null; if (slots[k].marker && driverMarker) createRoute(k); }});
});
clearByCodeBtn.addEventListener("click", clearByCode);

/* ========== Helper: POST wrapper ========== */
async function postJSON(url, data) {
  return fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) })
    .then(r => r.json());
}

/* ========== Start/Stop sharing ========== */
function startSharing() {
  if (!driverId) {
    alert("No driver logged in. Please login first.");
    window.location.href = "/"; // change to your login page if needed
    return;
  }
  if (!navigator.geolocation) return alert("Geolocation not supported in this browser.");

  sharing = 1;
  updateUISharing();

  // tell backend we are online
  postJSON("/updateOnline", { userId: driverId, online: 1 }).catch(()=>{});

  // watch position and POST to backend (so backend updates Firebase)
  watchId = navigator.geolocation.watchPosition(async (pos) => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const speed = pos.coords.speed;
    const accuracy = pos.coords.accuracy;
    const ts = pos.timestamp || Date.now();
    lastDriverPos = { lat, lng, speed, accuracy, ts };

    // update via backend endpoint (so DB is authoritative)
    postJSON("/driverLocation", { driverId, lat, lng }).catch(()=>{});

    // update map marker & UI
    if (!driverMarker) {
      driverMarker = L.marker([lat, lng]).addTo(map).bindPopup("You (Driver)").openPopup();
    } else {
      driverMarker.setLatLng([lat, lng]);
    }

    speedEl.textContent = speed ? (speed*3.6).toFixed(1) : 0;
    accEl.textContent = accuracy ? accuracy.toFixed(1) : "-";
    timeEl.textContent = new Date(ts).toLocaleTimeString();

    // update routes if riders exist
    ["s1","s2"].forEach(id => { if (slots[id].marker) updateRoute(id); });

    if (autoCenter && driverMarker) map.setView([lat, lng]);
  }, (err) => {
    messageEl.innerText = "GPS error: " + (err.message || err.code);
  }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 1000 });

  // start listening to *this driver's* DB node for bookings & rider updates
  listenToThisDriverNode();
}

function stopSharing() {
  sharing = 0;
  updateUISharing();
  postJSON("/updateOnline", { userId: driverId, online: 0 }).catch(()=>{});
  if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
}

/* ========== UI update ========== */
function updateUISharing() {
  statusEl.textContent = sharing ? "Sharing" : "Not sharing";
  statusEl.style.color = sharing ? "lightgreen" : "lightcoral";
  shareBtn.textContent = sharing ? "Stop Sharing" : "Start Sharing";
}

/* ========== Firebase listener for this driver node ==========
   We listen to drivers/{driverId} so only bookings assigned to this driver are shown.
   This prevents mixing other drivers' riders into your slots.
============================================================== */
let driverNodeUnsubscribe = null;
function listenToThisDriverNode() {
  if (!driverId) return;
  const nodeRef = ref(db, `drivers/${driverId}`);
  // only one listener (onValue) — automatically updsates slots
  onValue(nodeRef, snapshot => {
    const d = snapshot.val() || {};
    // Rider1
    if (d.Rider1_id) {
      slots.s1.mobile= d.Rider1_mobile;
      document.getElementById("rider1").innerHTML=slots.s1.mobile;
      slots.s1.riderId = d.Rider1_id;
      slots.s1.bookingCode = d.Booking1_code || null;
      const lat = d.Rider1_lat || null;
      const lng = d.Rider1_lng || null;
      if (!slots.s1.marker) slots.s1.marker = createRiderMarker(lat, lng, slots.s1.riderId);
      else if (lat != null && lng != null) slots.s1.marker.setLatLng([lat, lng]);
      updateSlotInfo("s1");
      updateRoute("s1");
    } else {
      removeSlot("s1");
    }

    // Rider2
    if (d.Rider2_id) {
        slots.s2.mobile= d.Rider2_mobile;
      document.getElementById("rider2").innerHTML=slots.s2.mobile;
      slots.s2.riderId = d.Rider2_id;
      slots.s2.bookingCode = d.Booking2_code || null;
      const lat = d.Rider2_lat || null;
      const lng = d.Rider2_lng || null;
      if (!slots.s2.marker) slots.s2.marker = createRiderMarker(lat, lng, slots.s2.riderId);
      else if (lat != null && lng != null) slots.s2.marker.setLatLng([lat, lng]);
      updateSlotInfo("s2");
      updateRoute("s2");
    } else {
      removeSlot("s2");
    }
  }, (err) => {
    console.warn("Firebase onValue error:", err);
  });
}

/* ========== Marker & routing utilities ========== */
function createRiderMarker(lat, lng, riderId) {
  const icon = L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/3448/3448339.png", iconSize: [36,36], iconAnchor:[18,36] });
  const m = L.marker([lat || 0, lng || 0], { icon }).addTo(map).bindPopup(`Rider: ${riderId}`);
  return m;
}

function createRoute(slotKey) {
  try {
    if (!driverMarker || !slots[slotKey].marker) return;
    if (slots[slotKey].route) { try { map.removeControl(slots[slotKey].route); } catch(e) {} slots[slotKey].route = null; }

    const profile = routeMode === "bike" ? "bike" : "car";
    const color = slotKey === "s1" ? "#2a7cff" : "#16a34a";
    const dash = slotKey === "s2" ? "6,8" : null;

    slots[slotKey].route = L.Routing.control({
      waypoints: [ driverMarker.getLatLng(), slots[slotKey].marker.getLatLng() ],
      router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile }),
      routeWhileDragging: false,
      addWaypoints: false,
      draggableWaypoints: false,
      createMarker: () => null,
      show: false,
      lineOptions: { styles: [{ color, opacity:0.9, weight:5, dashArray: dash }] }
    }).addTo(map);

    if (autoCenter) {
      try {
        const bounds = L.latLngBounds([ driverMarker.getLatLng(), slots[slotKey].marker.getLatLng() ]);
        map.fitBounds(bounds, { padding: [50,50] });
      } catch(e){}
    }
  } catch (e) {
    console.error("createRoute error:", e);
  }
}

function updateRoute(slotKey) {
  if (!slots[slotKey].route) { createRoute(slotKey); return; }
  if (!driverMarker || !slots[slotKey].marker) return;
  try {
    slots[slotKey].route.setWaypoints([ driverMarker.getLatLng(), slots[slotKey].marker.getLatLng() ]);
  } catch (e) {
    // fallback: recreate
    try { map.removeControl(slots[slotKey].route); } catch (err) {}
    slots[slotKey].route = null;
    createRoute(slotKey);
  }
}

/* ========== Slot UI helpers ========== */
function updateSlotInfo(slotKey) {
  const slot = slots[slotKey];
  const el = (slotKey === "s1") ? slot1Info : slot2Info;
  if (!slot.riderId && !slot.bookingCode) { el.innerText = "Empty"; return; }
  const m = slot.marker;
  const latlng = m ? m.getLatLng() : null;
  const label = slot.bookingCode ? `Booking Code:<div style="font-size:18px;color:lightgreen;">${slot.bookingCode}</div>` : `Rider ID: ${slot.riderId}`;
  el.innerHTML = `${label}${latlng ? `<br>Lat:${latlng.lat.toFixed(5)}, Lng:${latlng.lng.toFixed(5)}` : ""}`;
}

function removeSlot(slotKey) {
  if (slots[slotKey].marker) {
    try { map.removeLayer(slots[slotKey].marker); } catch(e) {}
    slots[slotKey].marker = null;
  }
  if (slots[slotKey].route) {
    try { map.removeControl(slots[slotKey].route); } catch(e) {}
    slots[slotKey].route = null;
  }
  slots[slotKey].riderId = null;
  slots[slotKey].bookingCode = null;
  updateSlotInfo(slotKey);
}

/* ========== Clear booking helpers ========== */
async function clearByCode(slotKey,code) {
  if(slotKey==="s2"){
         document.getElementById("rider2").innerHTML="";
  }else{
         document.getElementById("rider1").innerHTML="";
  }
  try {
    const resp = await postJSON("/target", { bookingCode: code });
    messageEl.innerText = `✅ ${resp.message || 'Cleared'}`;
    ["s1","s2"].forEach(k => { if (slots[k].bookingCode === code) removeSlot(k); });
  } catch (e) {
    console.error(e);
    messageEl.innerText = "❌ Failed to clear booking.";
  }
}

window.clearSlotPrompt=function(slotKey) {
  const code=(slotKey==="s1")?slots[slotKey].bookingCode:slots[slotKey].bookingCode;
  if (!code) return;
  clearByCode(slotKey,code);
}

/* ========== Center slot ========== */
window.centerSlot=function(slotKey) {
  if (!slots[slotKey].marker) return alert("No rider in this slot.");
  map.setView(slots[slotKey].marker.getLatLng(), 15);
}

/* ========== Utility: haversine (for ETA) ========== */
function haversineKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI/180;
  const dLon = (lon2 - lon1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ========== Auto-start if driverId exists ========== */
window.addEventListener("load", () => {
  // show reminder if not logged in
  if (!driverId) {
    console.warn("No driverId in localStorage. Please login as driver to use this page.");
    // do not automatically redirect if you want to test. uncomment to redirect:
    // window.location.href = "/"; // change to login page
    return;
  }
  startSharing();
});
</script>

<!-- Leaflet + RoutingMachine (loaded after module) -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
</body>
</html>
